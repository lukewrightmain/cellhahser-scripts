{
  "id": "script-1766639645555",
  "name": "Exported Python Script",
  "description": "Python script exported from Cellhasher Script Creator",
  "category": "Custom",
  "type": "Python",
  "version": "1.0.0",
  "author": "Cellhasher User",
  "tags": [
    "python",
    "exported"
  ],
  "effects": {
    "power": {
      "reboot": false,
      "shutdown": false
    },
    "security": {
      "modifiesLockScreen": false
    }
  },
  "preRunNotice": "This Python script was exported from Cellhasher Script Creator.",
  "pythonScript": "#!/usr/bin/env python3\r\n\"\"\"Cellhasher Termux SSH Setup\r\n\r\nRuns on the host machine (Windows/macOS/Linux) using the Python configured in Cellhasher Settings.\r\nUses adb to:\r\n- verify Termux is installed\r\n- push a Termux bash script to the device\r\n- open Termux and execute the script to install/configure OpenSSH\r\n\r\nNOTE: This script contains a placeholder token __TERMUX_SSH_PASSWORD__ that is replaced by the\r\nRust backend before execution.\r\n\"\"\"\r\n\r\nfrom __future__ import annotations\r\n\r\nimport os\r\nimport shlex\r\nimport subprocess\r\nimport sys\r\nimport tempfile\r\nimport time\r\n\r\n# Provided by Rust via template replacement.\r\n# After replacement, this should be a valid Python string literal.\r\nTERMUX_SSH_PASSWORD = __TERMUX_SSH_PASSWORD__\r\n\r\nADB = os.environ.get(\"adb_path\", \"adb\")\r\nDEVICES = os.environ.get(\"devices\", \"\").split()\r\n\r\n\r\ndef _creationflags() -> int:\r\n    if sys.platform == \"win32\":\r\n        return getattr(subprocess, \"CREATE_NO_WINDOW\", 0x08000000)\r\n    return 0\r\n\r\n\r\ndef run(args: list[str], *, check: bool = True, capture: bool = True) -> subprocess.CompletedProcess[str]:\r\n    print(\"[host]\", \" \".join(args))\r\n    return subprocess.run(\r\n        args,\r\n        check=check,\r\n        text=True,\r\n        capture_output=capture,\r\n        creationflags=_creationflags(),\r\n    )\r\n\r\n\r\ndef check_termux_installed(device_id: str) -> bool:\r\n    cp = run([ADB, \"-s\", device_id, \"shell\", \"pm\", \"list\", \"packages\", \"com.termux\"], check=False)\r\n    return \"com.termux\" in (cp.stdout or \"\")\r\n\r\n\r\ndef main() -> int:\r\n    if not DEVICES:\r\n        print(\"[error] No devices provided (env var 'devices' is empty)\")\r\n        return 2\r\n\r\n    if not isinstance(TERMUX_SSH_PASSWORD, str) or not TERMUX_SSH_PASSWORD.strip():\r\n        print(\"[error] TERMUX_SSH_PASSWORD is empty\")\r\n        return 2\r\n\r\n    device_id = DEVICES[0]\r\n    print(f\"[info] Setting up Termux SSH on: {device_id}\")\r\n\r\n    if not check_termux_installed(device_id):\r\n        print(\"[error] Termux is not installed on the device\")\r\n        return 3\r\n\r\n    # Bash script executed inside Termux.\r\n    # We embed password safely using shlex.quote for POSIX shells.\r\n    pw = shlex.quote(TERMUX_SSH_PASSWORD)\r\n    termux_bash_script = f\"\"\"#!/data/data/com.termux/files/usr/bin/bash\r\nset -e\r\n\r\nTERMUX_SSH_PASSWORD={pw}\r\n\r\nif command -v sshd >/dev/null 2>&1; then\r\n  echo \"OpenSSH already installed (sshd found)\"\r\nelse\r\n  pkg update -y\r\n  pkg install -y openssh\r\nfi\r\n\r\n# Update password (Termux's passwd prompts twice)\r\nif [ -n \"$TERMUX_SSH_PASSWORD\" ]; then\r\n  printf '%s\\n%s\\n' \"$TERMUX_SSH_PASSWORD\" \"$TERMUX_SSH_PASSWORD\" | passwd\r\nfi\r\n\r\n# Start sshd if not already running\r\nif ! pgrep -x sshd >/dev/null 2>&1; then\r\n  sshd\r\nfi\r\n\r\necho \"Termux SSH ready\"\r\n\"\"\"\r\n\r\n    # Temp debugging aid: print the exact Termux bash script we will run.\r\n    print(\"[debug] Termux bash script to run:\\n\" + termux_bash_script)\r\n\r\n    with tempfile.NamedTemporaryFile(mode=\"w\", encoding=\"utf-8\", newline=\"\\n\", delete=False, suffix=\".sh\") as f:\r\n        f.write(termux_bash_script)\r\n        local_script_path = f.name\r\n\r\n    device_script_path = \"/data/local/tmp/setup_ssh.sh\"\r\n\r\n    # Stop Termux first.\r\n    run([ADB, \"-s\", device_id, \"shell\", \"am\", \"force-stop\", \"com.termux\"], check=False)\r\n    time.sleep(1)\r\n\r\n    # Push script.\r\n    run([ADB, \"-s\", device_id, \"push\", local_script_path, device_script_path])\r\n    run([ADB, \"-s\", device_id, \"shell\", \"chmod\", \"755\", device_script_path])\r\n\r\n    # Launch Termux UI and run script (via keyboard injection).\r\n    run([ADB, \"-s\", device_id, \"shell\", \"am\", \"start\", \"-n\", \"com.termux/.app.TermuxActivity\"], check=False)\r\n    time.sleep(4)\r\n\r\n    # ADB input text uses %s for spaces.\r\n    typed = \"bash%s\" + device_script_path\r\n    run([ADB, \"-s\", device_id, \"shell\", \"input\", \"text\", typed], check=False)\r\n    time.sleep(0.5)\r\n    run([ADB, \"-s\", device_id, \"shell\", \"input\", \"keyevent\", \"66\"], check=False)\r\n\r\n    print(\"[info] Setup triggered. If Termux is open, you should see output.\")\r\n    return 0\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    raise SystemExit(main())"
}