{
  "id": "script-1767684271410",
  "name": "Exported Python Script",
  "description": "Python script exported from Cellhasher Script Creator",
  "category": "Custom",
  "type": "Python",
  "version": "1.0.0",
  "author": "Cellhasher User",
  "tags": [
    "python",
    "exported"
  ],
  "effects": {
    "power": {
      "reboot": false,
      "shutdown": false
    },
    "security": {
      "modifiesLockScreen": false
    }
  },
  "preRunNotice": "This Python script was exported from Cellhasher Script Creator.",
  "pythonScript": "#!/usr/bin/env python3\r\n\"\"\"\r\nPaperMC Minecraft Server - One-Click Deployment Script\r\nAutomatically installs Termux (if needed) and deploys PaperMC (latest) server on Android devices\r\nAuthor: Cellhasher Team\r\nVersion: 1.1.0\r\n\"\"\"\r\n\r\nimport os\r\nimport sys\r\nimport time\r\nimport subprocess\r\nimport tempfile\r\nimport urllib.request\r\nimport json\r\nimport ssl\r\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\r\n\r\n# Windows console encoding fix\r\nif sys.platform == 'win32':\r\n    try:\r\n        sys.stdout.reconfigure(encoding='utf-8', errors='replace')\r\n        sys.stderr.reconfigure(encoding='utf-8', errors='replace')\r\n    except Exception:\r\n        pass\r\n\r\n# Script metadata for Cellhasher integration\r\nSCRIPT_META = {\r\n    \"id\": \"minecraft-papermc-server-v1\",\r\n    \"name\": \"Minecraft PaperMC Server\",\r\n    \"description\": \"One-click PaperMC Minecraft server deployment. Automatically installs Termux if needed, configures Java 21, downloads the latest Paper version, and starts the server.\",\r\n    \"category\": \"Gaming\",\r\n    \"type\": \"python\",\r\n    \"version\": \"1.1.0\",\r\n    \"author\": \"Cellhasher Team\",\r\n    \"difficulty\": \"Advanced\",\r\n    \"estimatedTime\": \"5-10 min\",\r\n    \"tags\": [\"minecraft\", \"server\", \"papermc\", \"gaming\", \"termux\"],\r\n    \"effects\": {\r\n        \"power\": {\"reboot\": False, \"shutdown\": False},\r\n        \"security\": {\"modifiesLockScreen\": False}\r\n    },\r\n    \"estimatedDurationSec\": 600,\r\n    \"downloads\": 0,\r\n    \"rating\": 5.0,\r\n    \"lastUpdated\": \"today\"\r\n}\r\n\r\n# Get environment variables from Cellhasher\r\nADB = os.environ.get(\"adb_path\", \"adb\")\r\ndevices = os.environ.get(\"devices\", \"\").split()\r\n\r\n# GitHub API endpoint for Termux app releases\r\nGITHUB_API_URL = \"https://api.github.com/repos/termux/termux-app/releases/latest\"\r\n\r\n# PaperMC installation bash script for Termux\r\n# This script dynamically fetches the latest Paper version using the PaperMC API\r\nPAPERMC_INSTALL_SCRIPT = r'''#!/data/data/com.termux/files/usr/bin/bash\r\nset -e\r\n\r\necho \"==============================================\"\r\necho \"   PaperMC Minecraft Server Installer\"\r\necho \"   Dynamic Latest Version | Java 21\"\r\necho \"==============================================\"\r\necho \"\"\r\n\r\n# Step 1: Update system\r\necho \"[1/7] Updating Termux packages...\"\r\nyes '' | pkg upgrade -y 2>/dev/null || true\r\npkg update -y 2>/dev/null || true\r\necho \"[OK] System updated!\"\r\necho \"\"\r\n\r\n# Step 2: Install dependencies\r\necho \"[2/7] Installing dependencies (openjdk-21, curl, jq)...\"\r\npkg install -y openjdk-21 curl jq 2>/dev/null || {\r\n    echo \"[!] First attempt failed, retrying...\"\r\n    pkg install -y openjdk-21 curl jq\r\n}\r\necho \"[OK] Dependencies installed!\"\r\necho \"\"\r\n\r\n# Enforce Java 21 usage (important for MC 1.21+)\r\nexport JAVA_HOME=$PREFIX/lib/jvm/java-21-openjdk\r\nexport PATH=$JAVA_HOME/bin:$PATH\r\n\r\necho \"[OK] Java enforced:\"\r\njava -version\r\necho \"\"\r\n\r\n# Step 3: Create server directory\r\necho \"[3/7] Creating Minecraft server directory...\"\r\nmkdir -p ~/mc\r\ncd ~/mc\r\necho \"[OK] Server directory ready: ~/mc\"\r\necho \"\"\r\n\r\n# Step 4: Download latest PaperMC server\r\necho \"[4/7] Fetching latest PaperMC version...\"\r\n\r\nLATEST_VERSION=$(curl -s https://api.papermc.io/v2/projects/paper | jq -r '.versions[-1]')\r\nLATEST_BUILD=$(curl -s https://api.papermc.io/v2/projects/paper/versions/$LATEST_VERSION | jq -r '.builds[-1]')\r\n\r\nPAPER_URL=\"https://api.papermc.io/v2/projects/paper/versions/$LATEST_VERSION/builds/$LATEST_BUILD/downloads/paper-$LATEST_VERSION-$LATEST_BUILD.jar\"\r\n\r\necho \"[*] Latest Paper version: $LATEST_VERSION (build $LATEST_BUILD)\"\r\n\r\nrm -f paper.jar\r\ncurl -L -o paper.jar \"$PAPER_URL\" --progress-bar\r\n\r\nif [ ! -f paper.jar ]; then\r\n    echo \"[ERROR] Failed to download PaperMC!\"\r\n    exit 1\r\nfi\r\n\r\nFILE_SIZE=$(du -h paper.jar | cut -f1)\r\necho \"[OK] PaperMC downloaded successfully ($FILE_SIZE)\"\r\necho \"\"\r\n\r\n# Step 5: Initial server run (generates EULA)\r\necho \"[5/7] Running initial server startup to generate EULA...\"\r\necho \"[*] This will fail with EULA error - that's expected!\"\r\njava -Xms512M -Xmx1024M -jar paper.jar nogui 2>&1 || true\r\necho \"[OK] Initial run complete!\"\r\necho \"\"\r\n\r\n# Step 6: Accept EULA automatically\r\necho \"[6/7] Accepting Minecraft EULA...\"\r\nif [ -f \"eula.txt\" ]; then\r\n    sed -i 's/eula=false/eula=true/g' eula.txt\r\n    echo \"[OK] EULA accepted!\"\r\nelse\r\n    echo \"eula=true\" > eula.txt\r\n    echo \"[OK] EULA file created and accepted!\"\r\nfi\r\necho \"\"\r\n\r\n# Step 7: Configure server.properties for mobile\r\necho \"[7/7] Configuring server for mobile optimization...\"\r\nif [ -f \"server.properties\" ]; then\r\n    # Optimize for mobile devices\r\n    sed -i 's/view-distance=10/view-distance=6/g' server.properties 2>/dev/null || true\r\n    sed -i 's/simulation-distance=10/simulation-distance=4/g' server.properties 2>/dev/null || true\r\n    sed -i 's/max-players=20/max-players=5/g' server.properties 2>/dev/null || true\r\n    echo \"[OK] Server configured for mobile!\"\r\nelse\r\n    echo \"[*] server.properties will be created on first run\"\r\nfi\r\necho \"\"\r\n\r\necho \"==============================================\"\r\necho \"   Installation Complete!\"\r\necho \"==============================================\"\r\necho \"\"\r\necho \"To start your Minecraft server, run:\"\r\necho \"  cd ~/mc && java -Xms512M -Xmx1024M -jar paper.jar nogui\"\r\necho \"\"\r\necho \"Server will be available on port 25565\"\r\necho \"Connect using your device's IP address\"\r\necho \"\"\r\n\r\n# Final server start\r\necho \"[*] Starting Minecraft server now...\"\r\necho \"==============================================\"\r\njava -Xms512M -Xmx1024M -jar paper.jar nogui\r\n'''\r\n\r\n\r\ndef setup_ssl_context():\r\n    \"\"\"Setup SSL context to handle certificate verification issues\"\"\"\r\n    try:\r\n        if hasattr(ssl, '_create_unverified_context'):\r\n            ssl_context = ssl._create_unverified_context()\r\n            return ssl_context\r\n        else:\r\n            ssl_context = ssl.create_default_context()\r\n            return ssl_context\r\n    except Exception as e:\r\n        print(f\"[!] SSL setup warning: {e}\")\r\n        return None\r\n\r\n\r\ndef get_latest_termux_apk():\r\n    \"\"\"Fetch the latest Termux arm64-v8a APK download URL from GitHub releases\"\"\"\r\n    try:\r\n        print(\"[*] Fetching latest Termux release from GitHub...\")\r\n        ssl_context = setup_ssl_context()\r\n        req = urllib.request.Request(\r\n            GITHUB_API_URL, \r\n            headers={'User-Agent': 'Cellhasher-Minecraft-Deployer/1.0'}\r\n        )\r\n        \r\n        if ssl_context:\r\n            with urllib.request.urlopen(req, timeout=30, context=ssl_context) as response:\r\n                release_data = json.loads(response.read().decode())\r\n        else:\r\n            with urllib.request.urlopen(req, timeout=30) as response:\r\n                release_data = json.loads(response.read().decode())\r\n\r\n        print(f\"[OK] Fetched release: {release_data.get('tag_name', 'unknown')}\")\r\n\r\n        # Find the arm64-v8a APK\r\n        for asset in release_data.get(\"assets\", []):\r\n            if \"arm64-v8a\" in asset[\"name\"].lower() and asset[\"name\"].endswith(\".apk\"):\r\n                apk_url = asset[\"browser_download_url\"]\r\n                apk_name = asset[\"name\"]\r\n                print(f\"[OK] Found APK: {apk_name}\")\r\n                return apk_url, apk_name\r\n\r\n        raise Exception(\"Could not find arm64-v8a APK in latest release\")\r\n    except Exception as e:\r\n        print(f\"[ERROR] Error fetching release info: {e}\")\r\n        raise\r\n\r\n\r\ndef download_apk(apk_url, apk_name):\r\n    \"\"\"Download the APK to a temporary location\"\"\"\r\n    try:\r\n        temp_dir = tempfile.gettempdir()\r\n        local_apk_path = os.path.join(temp_dir, apk_name)\r\n        \r\n        print(f\"[*] Downloading {apk_name}...\")\r\n        \r\n        req = urllib.request.Request(\r\n            apk_url, \r\n            headers={'User-Agent': 'Cellhasher-Minecraft-Deployer/1.0'}\r\n        )\r\n        ssl_context = setup_ssl_context()\r\n        \r\n        if ssl_context:\r\n            with urllib.request.urlopen(req, timeout=120, context=ssl_context) as response:\r\n                with open(local_apk_path, 'wb') as f:\r\n                    while True:\r\n                        chunk = response.read(8192)\r\n                        if not chunk:\r\n                            break\r\n                        f.write(chunk)\r\n        else:\r\n            with urllib.request.urlopen(req, timeout=120) as response:\r\n                with open(local_apk_path, 'wb') as f:\r\n                    while True:\r\n                        chunk = response.read(8192)\r\n                        if not chunk:\r\n                            break\r\n                        f.write(chunk)\r\n        \r\n        file_size = os.path.getsize(local_apk_path)\r\n        print(f\"[OK] Downloaded! Size: {file_size / (1024 * 1024):.2f} MB\")\r\n        return local_apk_path\r\n    except Exception as e:\r\n        print(f\"[ERROR] Error downloading APK: {e}\")\r\n        raise\r\n\r\n\r\ndef check_termux_installed(device_id):\r\n    \"\"\"Check if Termux is installed on the device\"\"\"\r\n    try:\r\n        result = subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} shell pm list packages com.termux',\r\n            shell=True,\r\n            capture_output=True,\r\n            text=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        return \"com.termux\" in result.stdout\r\n    except Exception as e:\r\n        print(f\"[{device_id}] Error checking Termux: {e}\")\r\n        return False\r\n\r\n\r\ndef install_termux_on_device(device_id, apk_path):\r\n    \"\"\"Install Termux APK on a device\"\"\"\r\n    try:\r\n        print(f\"[{device_id}] Installing Termux...\")\r\n        result = subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} install -r \"{apk_path}\"',\r\n            shell=True,\r\n            capture_output=True,\r\n            text=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        \r\n        if result.returncode == 0 or \"Success\" in result.stdout:\r\n            print(f\"[{device_id}] [OK] Termux installed successfully!\")\r\n            return True\r\n        else:\r\n            print(f\"[{device_id}] [ERROR] Termux installation failed: {result.stderr or result.stdout}\")\r\n            return False\r\n    except Exception as e:\r\n        print(f\"[{device_id}] [ERROR] Error installing Termux: {e}\")\r\n        return False\r\n\r\n\r\ndef grant_termux_permissions(device_id):\r\n    \"\"\"Grant necessary permissions to Termux\"\"\"\r\n    permissions = [\r\n        \"android.permission.WRITE_EXTERNAL_STORAGE\",\r\n        \"android.permission.READ_EXTERNAL_STORAGE\",\r\n        \"android.permission.INTERNET\",\r\n        \"android.permission.ACCESS_NETWORK_STATE\",\r\n        \"android.permission.WAKE_LOCK\",\r\n        \"android.permission.FOREGROUND_SERVICE\",\r\n    ]\r\n    \r\n    for perm in permissions:\r\n        try:\r\n            subprocess.run(\r\n                f'\"{ADB}\" -s {device_id} shell pm grant com.termux {perm}',\r\n                shell=True,\r\n                capture_output=True,\r\n                creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n            )\r\n        except Exception:\r\n            pass  # Some permissions may not be grantable, continue anyway\r\n\r\n\r\ndef deploy_papermc_server(device_id, script_path):\r\n    \"\"\"Deploy and run PaperMC server installation on a device\"\"\"\r\n    try:\r\n        print(f\"[{device_id}] Starting PaperMC deployment...\")\r\n        \r\n        # Step 1: Check if Termux is installed\r\n        print(f\"[{device_id}] Checking Termux installation...\")\r\n        termux_installed = check_termux_installed(device_id)\r\n        \r\n        if not termux_installed:\r\n            print(f\"[{device_id}] Termux not found, installation required...\")\r\n            return \"NEEDS_TERMUX\"\r\n        \r\n        print(f\"[{device_id}] [OK] Termux is installed!\")\r\n        \r\n        # Step 2: Force stop Termux if running\r\n        subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} shell am force-stop com.termux',\r\n            shell=True,\r\n            capture_output=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        time.sleep(1)\r\n        \r\n        # Step 3: Push the installation script to device\r\n        device_temp_path = \"/data/local/tmp/papermc_install.sh\"\r\n        print(f\"[{device_id}] Pushing installation script...\")\r\n        \r\n        result = subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} push \"{script_path}\" \"{device_temp_path}\"',\r\n            shell=True,\r\n            capture_output=True,\r\n            text=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        \r\n        if result.returncode != 0:\r\n            print(f\"[{device_id}] [ERROR] Failed to push script: {result.stderr}\")\r\n            return f\"[{device_id}] Error: Failed to push script\"\r\n        \r\n        # Step 4: Make script executable\r\n        print(f\"[{device_id}] Setting script permissions...\")\r\n        subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} shell chmod 755 {device_temp_path}',\r\n            shell=True,\r\n            capture_output=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        \r\n        # Step 5: Grant Termux permissions\r\n        print(f\"[{device_id}] Granting Termux permissions...\")\r\n        grant_termux_permissions(device_id)\r\n        \r\n        # Step 6: Launch Termux and wait for initialization\r\n        print(f\"[{device_id}] Launching Termux...\")\r\n        subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} shell am start -n com.termux/com.termux.app.TermuxActivity',\r\n            shell=True,\r\n            capture_output=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        \r\n        # Wait for Termux to fully initialize (first launch takes longer)\r\n        print(f\"[{device_id}] Waiting for Termux initialization (15 seconds)...\")\r\n        time.sleep(15)\r\n        \r\n        # Step 7: Type and execute the installation command\r\n        # Using %s for spaces in adb shell input text\r\n        adb_typed_cmd = \"bash%s/data/local/tmp/papermc_install.sh\"\r\n        print(f\"[{device_id}] Sending installation command...\")\r\n        \r\n        subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} shell input text \"{adb_typed_cmd}\"',\r\n            shell=True,\r\n            capture_output=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        time.sleep(0.5)\r\n        \r\n        # Press Enter to execute\r\n        subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} shell input keyevent 66',\r\n            shell=True,\r\n            capture_output=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        \r\n        print(f\"[{device_id}] [OK] PaperMC installation started!\")\r\n        print(f\"[{device_id}] Server will be available on port 25565 once ready\")\r\n        return f\"[{device_id}] Success - Installation started\"\r\n        \r\n    except Exception as e:\r\n        print(f\"[{device_id}] [ERROR] {e}\")\r\n        return f\"[{device_id}] Error: {e}\"\r\n\r\n\r\ndef main():\r\n    \"\"\"Main execution function\"\"\"\r\n    print(\"=\" * 60)\r\n    print(\"   Minecraft PaperMC Server - One-Click Deployment\")\r\n    print(\"   Dynamic Latest Version | Java 21 | ARM64\")\r\n    print(\"=\" * 60)\r\n    print()\r\n    \r\n    if not devices:\r\n        print(\"[ERROR] No devices found in environment variable 'devices'\")\r\n        print(\"[!] Please select devices in Cellhasher before running this script\")\r\n        return\r\n    \r\n    print(f\"[*] Target devices: {len(devices)}\")\r\n    for idx, device in enumerate(devices, 1):\r\n        print(f\"    {idx}. {device}\")\r\n    print()\r\n    \r\n    # Create temporary script file\r\n    print(\"[*] Creating installation script...\")\r\n    with tempfile.NamedTemporaryFile(\r\n        mode='w', \r\n        encoding='utf-8', \r\n        newline='\\n', \r\n        delete=False, \r\n        suffix='.sh'\r\n    ) as f:\r\n        f.write(PAPERMC_INSTALL_SCRIPT)\r\n        local_script_path = f.name\r\n    print(f\"[OK] Script saved to: {local_script_path}\")\r\n    print()\r\n    \r\n    # Phase 1: Check which devices need Termux installed\r\n    print(\"=\" * 60)\r\n    print(\"[Phase 1] Checking Termux installation status...\")\r\n    print(\"=\" * 60)\r\n    \r\n    devices_need_termux = []\r\n    devices_ready = []\r\n    \r\n    for device_id in devices:\r\n        if check_termux_installed(device_id):\r\n            print(f\"[{device_id}] [OK] Termux installed\")\r\n            devices_ready.append(device_id)\r\n        else:\r\n            print(f\"[{device_id}] [!] Termux NOT installed\")\r\n            devices_need_termux.append(device_id)\r\n    \r\n    print()\r\n    \r\n    # Phase 2: Install Termux on devices that need it\r\n    if devices_need_termux:\r\n        print(\"=\" * 60)\r\n        print(f\"[Phase 2] Installing Termux on {len(devices_need_termux)} device(s)...\")\r\n        print(\"=\" * 60)\r\n        \r\n        try:\r\n            # Download Termux APK once\r\n            apk_url, apk_name = get_latest_termux_apk()\r\n            apk_path = download_apk(apk_url, apk_name)\r\n            \r\n            # Install on all devices that need it in parallel\r\n            max_workers = max(1, len(devices_need_termux))\r\n            with ThreadPoolExecutor(max_workers=max_workers) as executor:\r\n                future_to_device = {\r\n                    executor.submit(install_termux_on_device, device_id, apk_path): device_id\r\n                    for device_id in devices_need_termux\r\n                }\r\n                \r\n                for future in as_completed(future_to_device):\r\n                    device_id = future_to_device[future]\r\n                    try:\r\n                        success = future.result()\r\n                        if success:\r\n                            devices_ready.append(device_id)\r\n                    except Exception as exc:\r\n                        print(f\"[{device_id}] Installation exception: {exc}\")\r\n            \r\n            # Cleanup APK\r\n            if os.path.exists(apk_path):\r\n                os.unlink(apk_path)\r\n                print(f\"[OK] Cleaned up temporary APK\")\r\n            \r\n            # Wait for Termux to be ready after installation\r\n            print(\"[*] Waiting 5 seconds for Termux installations to settle...\")\r\n            time.sleep(5)\r\n            \r\n        except Exception as e:\r\n            print(f\"[ERROR] Failed to download/install Termux: {e}\")\r\n            print(\"[!] Continuing with devices that already have Termux...\")\r\n        \r\n        print()\r\n    else:\r\n        print(\"[OK] All devices already have Termux installed!\")\r\n        print()\r\n    \r\n    # Phase 3: Deploy PaperMC server\r\n    if not devices_ready:\r\n        print(\"[ERROR] No devices available for PaperMC deployment!\")\r\n        os.unlink(local_script_path)\r\n        return\r\n    \r\n    print(\"=\" * 60)\r\n    print(f\"[Phase 3] Deploying PaperMC server on {len(devices_ready)} device(s)...\")\r\n    print(\"=\" * 60)\r\n    print()\r\n    \r\n    max_workers = max(1, len(devices_ready))\r\n    results = []\r\n    \r\n    with ThreadPoolExecutor(max_workers=max_workers) as executor:\r\n        future_to_device = {\r\n            executor.submit(deploy_papermc_server, device_id, local_script_path): device_id\r\n            for device_id in devices_ready\r\n        }\r\n        \r\n        for future in as_completed(future_to_device):\r\n            device_id = future_to_device[future]\r\n            try:\r\n                result = future.result()\r\n                results.append(result)\r\n                print(result)\r\n            except Exception as exc:\r\n                print(f\"[{device_id}] Generated an exception: {exc}\")\r\n    \r\n    # Cleanup\r\n    print()\r\n    print(\"[*] Cleaning up temporary files...\")\r\n    if os.path.exists(local_script_path):\r\n        os.unlink(local_script_path)\r\n        print(\"[OK] Removed temporary script file\")\r\n    \r\n    # Summary\r\n    print()\r\n    print(\"=\" * 60)\r\n    print(\"   Deployment Summary\")\r\n    print(\"=\" * 60)\r\n    successful = sum(1 for r in results if \"Success\" in r)\r\n    print(f\"[*] Devices processed: {len(devices_ready)}\")\r\n    print(f\"[*] Successful deployments: {successful}\")\r\n    print()\r\n    print(\"[INFO] The Minecraft server installation is now running on each device.\")\r\n    print(\"[INFO] Installation may take 5-10 minutes to complete.\")\r\n    print(\"[INFO] Once ready, connect to: <device-ip>:25565\")\r\n    print()\r\n    print(\"[TIP] To check server status, open Termux on the device\")\r\n    print(\"[TIP] To restart server: cd ~/mc && java -Xms512M -Xmx1024M -jar paper.jar nogui\")\r\n    print(\"=\" * 60)\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    main()"
}