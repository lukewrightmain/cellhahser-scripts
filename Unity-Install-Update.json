{
  "id": "7b7afcaf-8d46-44fc-b2d7-1608cb01bc39",
  "name": "Unity Install & Update",
  "description": "News Python, Auto Installs the Latest Unity APK, Can be used to Update App aswell with newest release",
  "category": "Custom",
  "type": "Python",
  "version": "1.0.0",
  "author": "Cellhasher",
  "tags": [
    "python",
    "unity"
  ],
  "effects": {
    "power": {
      "reboot": false,
      "shutdown": false
    },
    "security": {
      "modifiesLockScreen": false
    }
  },
  "preRunNotice": "This Python script was exported from Cellhasher My Scripts.",
  "pythonScript": "import os\r\nimport time\r\nimport subprocess\r\nimport tempfile\r\nimport urllib.request\r\nimport urllib.parse\r\nimport re\r\nimport ssl\r\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\r\nfrom html.parser import HTMLParser\r\n\r\n# Windows console encoding fix\r\nimport sys\r\nif sys.platform == 'win32':\r\n    try:\r\n        import codecs\r\n        sys.stdout.reconfigure(encoding='utf-8', errors='replace')\r\n        sys.stderr.reconfigure(encoding='utf-8', errors='replace')\r\n    except Exception:\r\n        pass  # Continue if reconfigure fails\r\n\r\n# Get environment variables from Cellhasher\r\nADB = os.environ.get(\"adb_path\", \"adb\")\r\ndevices = os.environ.get(\"devices\", \"\").split()\r\n\r\n# Unity releases directory URL\r\nUNITY_RELEASES_URL = \"https://releases.unitynodes.io/android/\"\r\n\r\nclass UnityAPKParser(HTMLParser):\r\n    \"\"\"\r\n    Parse HTML directory listing to extract Unity APK files\r\n    \"\"\"\r\n    def __init__(self):\r\n        super().__init__()\r\n        self.apk_files = []\r\n    \r\n    def handle_starttag(self, tag, attrs):\r\n        if tag == 'a':\r\n            for attr, value in attrs:\r\n                if attr == 'href' and value.startswith('Unity-') and value.endswith('.apk'):\r\n                    # URL-decode the filename (e.g., %2B becomes +)\r\n                    decoded_value = urllib.parse.unquote(value)\r\n                    self.apk_files.append(decoded_value)\r\n\r\ndef setup_ssl_context():\r\n    \"\"\"\r\n    Setup SSL context to handle certificate verification issues\r\n    \"\"\"\r\n    try:\r\n        # Try to create unverified context if available (for systems with SSL issues)\r\n        if hasattr(ssl, '_create_unverified_context'):\r\n            ssl_context = ssl._create_unverified_context()\r\n            print(\"[✓] SSL: Using unverified context\")\r\n            return ssl_context\r\n        else:\r\n            # Fallback to default context\r\n            ssl_context = ssl.create_default_context()\r\n            print(\"[✓] SSL: Using default context\")\r\n            return ssl_context\r\n    except Exception as e:\r\n        print(f\"[!] SSL setup warning: {e}\")\r\n        # Continue without custom SSL context\r\n        return None\r\n\r\ndef parse_version(filename):\r\n    \"\"\"\r\n    Extract version and date from Unity APK filename\r\n    Returns the date for sorting (date is most reliable indicator)\r\n    Example: Unity-0.1.3+2025-11-29.apk -> '2025-11-29'\r\n    \"\"\"\r\n    match = re.match(r'Unity-[\\d.]+\\+(\\d{4}-\\d{2}-\\d{2})\\.apk', filename)\r\n    if match:\r\n        return match.group(1)\r\n    return '0000-00-00'\r\n\r\ndef get_latest_unity_apk():\r\n    \"\"\"\r\n    Fetch the latest Unity APK download URL from the releases directory\r\n    \"\"\"\r\n    try:\r\n        print(\"[*] Fetching latest Unity Node release...\")\r\n        \r\n        # Setup SSL context\r\n        ssl_context = setup_ssl_context()\r\n        \r\n        # Add user agent to avoid potential blocking\r\n        req = urllib.request.Request(UNITY_RELEASES_URL, headers={'User-Agent': 'Cellhasher-Unity-Updater/1.0'})\r\n        \r\n        # Use SSL context if available\r\n        if ssl_context:\r\n            with urllib.request.urlopen(req, timeout=30, context=ssl_context) as response:\r\n                html_content = response.read().decode('utf-8')\r\n        else:\r\n            with urllib.request.urlopen(req, timeout=30) as response:\r\n                html_content = response.read().decode('utf-8')\r\n        \r\n        # Parse the HTML to find all Unity APK files\r\n        parser = UnityAPKParser()\r\n        parser.feed(html_content)\r\n        \r\n        if not parser.apk_files:\r\n            raise Exception(\"No Unity APK files found in releases directory\")\r\n        \r\n        print(f\"[*] Found {len(parser.apk_files)} Unity APK file(s)\")\r\n        \r\n        # Sort by date to get the latest (date format YYYY-MM-DD sorts correctly)\r\n        sorted_apks = sorted(parser.apk_files, key=parse_version, reverse=True)\r\n        latest_apk = sorted_apks[0]\r\n        \r\n        release_date = parse_version(latest_apk)\r\n        # Extract version from filename for display\r\n        version_match = re.match(r'Unity-([\\d.]+)\\+', latest_apk)\r\n        version = version_match.group(1) if version_match else \"unknown\"\r\n        \r\n        print(f\"[✓] Found latest Unity APK: {latest_apk}\")\r\n        print(f\"[✓] Version: {version} | Release Date: {release_date}\")\r\n        \r\n        # URL-encode the filename for the download URL\r\n        encoded_filename = urllib.parse.quote(latest_apk)\r\n        apk_url = UNITY_RELEASES_URL + encoded_filename\r\n        print(f\"[✓] Download URL: {apk_url}\")\r\n        \r\n        return apk_url, latest_apk\r\n    \r\n    except Exception as e:\r\n        print(f\"[✗] Error fetching release info: {e}\")\r\n        raise\r\n\r\ndef download_apk(apk_url, apk_name):\r\n    \"\"\"\r\n    Download the APK to a temporary location\r\n    \"\"\"\r\n    try:\r\n        # Create temporary file for the APK\r\n        temp_dir = tempfile.gettempdir()\r\n        local_apk_path = os.path.join(temp_dir, apk_name)\r\n        \r\n        print(f\"[*] Downloading {apk_name}...\")\r\n        print(f\"[*] Saving to: {local_apk_path}\")\r\n        \r\n        # Setup SSL context\r\n        ssl_context = setup_ssl_context()\r\n        \r\n        # Add user agent and timeout for better reliability\r\n        req = urllib.request.Request(apk_url, headers={'User-Agent': 'Cellhasher-Unity-Updater/1.0'})\r\n        \r\n        if ssl_context:\r\n            with urllib.request.urlopen(req, timeout=120, context=ssl_context) as response:\r\n                total_size = int(response.headers.get('content-length', 0))\r\n                downloaded = 0\r\n                \r\n                with open(local_apk_path, 'wb') as f:\r\n                    while True:\r\n                        chunk = response.read(8192)\r\n                        if not chunk:\r\n                            break\r\n                        f.write(chunk)\r\n                        downloaded += len(chunk)\r\n                        \r\n                        # Show progress if total size is known\r\n                        if total_size > 0:\r\n                            progress = (downloaded / total_size) * 100\r\n                            print(f\"\\r[*] Progress: {progress:.1f}% ({downloaded / (1024 * 1024):.1f} MB / {total_size / (1024 * 1024):.1f} MB)\", end='', flush=True)\r\n        else:\r\n            with urllib.request.urlopen(req, timeout=120) as response:\r\n                with open(local_apk_path, 'wb') as f:\r\n                    while True:\r\n                        chunk = response.read(8192)\r\n                        if not chunk:\r\n                            break\r\n                        f.write(chunk)\r\n        \r\n        print()  # New line after progress\r\n        \r\n        # Verify the file was downloaded\r\n        file_size = os.path.getsize(local_apk_path)\r\n        print(f\"[✓] Downloaded successfully! Size: {file_size / (1024 * 1024):.2f} MB\")\r\n        \r\n        return local_apk_path\r\n    \r\n    except Exception as e:\r\n        print(f\"[✗] Error downloading APK: {e}\")\r\n        raise\r\n\r\ndef install_apk_on_device(device_id, apk_path):\r\n    \"\"\"\r\n    Install or update Unity Node APK on a single device using ADB\r\n    \"\"\"\r\n    try:\r\n        print(f\"[{device_id}] Starting Unity Node installation/update...\")\r\n        \r\n        # Install the APK (adb install -r for update/replace)\r\n        print(f\"[{device_id}] Installing APK...\")\r\n        result = subprocess.run(\r\n            f'\"{ADB}\" -s {device_id} install -r \"{apk_path}\"',\r\n            shell=True,\r\n            capture_output=True,\r\n            text=True,\r\n            creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0\r\n        )\r\n        \r\n        if result.returncode == 0 or \"Success\" in result.stdout:\r\n            print(f\"[{device_id}] ✓ Unity Node installed/updated successfully!\")\r\n            return f\"[{device_id}] Success\"\r\n        else:\r\n            error_msg = result.stderr or result.stdout\r\n            print(f\"[{device_id}] ✗ Installation failed: {error_msg}\")\r\n            return f\"[{device_id}] Failed: {error_msg}\"\r\n    \r\n    except Exception as e:\r\n        print(f\"[{device_id}] ✗ Error: {e}\")\r\n        return f\"[{device_id}] Error: {e}\"\r\n\r\ndef main():\r\n    \"\"\"\r\n    Main execution function\r\n    \"\"\"\r\n    print(\"=\" * 60)\r\n    print(\"    Unity Node - Install/Update Script\")\r\n    print(\"=\" * 60)\r\n    \r\n    if not devices:\r\n        print(\"[✗] No devices found in environment variable 'devices'\")\r\n        print(\"[!] Please select devices in Cellhasher before running this script\")\r\n        return\r\n    \r\n    print(f\"[*] Target devices: {len(devices)}\")\r\n    for idx, device in enumerate(devices, 1):\r\n        print(f\"    {idx}. {device}\")\r\n    print()\r\n    \r\n    try:\r\n        # Step 1: Get latest APK download URL\r\n        apk_url, apk_name = get_latest_unity_apk()\r\n        \r\n        # Step 2: Download the APK\r\n        apk_path = download_apk(apk_url, apk_name)\r\n        \r\n        # Step 3: Install on all devices in parallel\r\n        print()\r\n        print(\"=\" * 60)\r\n        print(f\"[*] Installing Unity Node on {len(devices)} device(s) in parallel...\")\r\n        print(\"=\" * 60)\r\n        print()\r\n        \r\n        max_workers = max(1, len(devices))\r\n        with ThreadPoolExecutor(max_workers=max_workers) as executor:\r\n            future_to_device = {\r\n                executor.submit(install_apk_on_device, device_id, apk_path): device_id \r\n                for device_id in devices\r\n            }\r\n            \r\n            for future in as_completed(future_to_device):\r\n                device_id = future_to_device[future]\r\n                try:\r\n                    result = future.result()\r\n                    print(result)\r\n                except Exception as exc:\r\n                    print(f\"[{device_id}] Generated an exception: {exc}\")\r\n        \r\n        # Step 4: Cleanup - remove downloaded APK\r\n        print()\r\n        print(\"[*] Cleaning up temporary files...\")\r\n        if os.path.exists(apk_path):\r\n            os.unlink(apk_path)\r\n            print(f\"[✓] Removed temporary APK: {apk_path}\")\r\n        \r\n        print()\r\n        print(\"=\" * 60)\r\n        print(\"[✓] Unity Node installation/update completed on all devices!\")\r\n        print(\"=\" * 60)\r\n    \r\n    except Exception as e:\r\n        print(f\"[✗] Script failed: {e}\")\r\n        return\r\n\r\nif __name__ == \"__main__\":\r\n    main()"
}